# Etap builda
FROM node:18-alpine AS builder

ARG NEXT_PUBLIC_KEYCLOAK_URL
ARG NEXT_PUBLIC_REALM
ARG NEXT_PUBLIC_CLIENT_ID
ARG NEXT_PUBLIC_USER_URL
ARG NEXT_PUBLIC_VOICE_URL

ENV NEXT_PUBLIC_KEYCLOAK_URL=$NEXT_PUBLIC_KEYCLOAK_URL
ENV NEXT_PUBLIC_REALM=$NEXT_PUBLIC_REALM
ENV NEXT_PUBLIC_CLIENT_ID=$NEXT_PUBLIC_CLIENT_ID
ENV NEXT_PUBLIC_USER_URL=$NEXT_PUBLIC_USER_URL
ENV NEXT_PUBLIC_VOICE_URL=$NEXT_PUBLIC_VOICE_URL

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . ./
RUN npm run build

# produkcja
FROM node:18-alpine AS runner

ARG NEXT_PUBLIC_KEYCLOAK_URL
ARG NEXT_PUBLIC_REALM
ARG NEXT_PUBLIC_CLIENT_ID
ARG NEXT_PUBLIC_USER_URL
ARG NEXT_PUBLIC_VOICE_URL

ENV NEXT_PUBLIC_KEYCLOAK_URL=$NEXT_PUBLIC_KEYCLOAK_URL
ENV NEXT_PUBLIC_REALM=$NEXT_PUBLIC_REALM
ENV NEXT_PUBLIC_CLIENT_ID=$NEXT_PUBLIC_CLIENT_ID
ENV NEXT_PUBLIC_USER_URL=$NEXT_PUBLIC_USER_URL
ENV NEXT_PUBLIC_VOICE_URL=$NEXT_PUBLIC_VOICE_URL

WORKDIR /app
COPY --from=builder /app ./
RUN npm install --omit=dev

EXPOSE 3000
CMD ["npm", "run", "dev"]

# ? Dla kubernetes buildx
# CMD ["npm", "start"]
# CMD ["npx", "next", "start", "-H", "0.0.0.0"]

# ? Dla buildx
# docker build \
# --build-arg NEXT_PUBLIC_KEYCLOAK_URL=https://voice-chat.pl \
# --build-arg NEXT_PUBLIC_REALM=voice-chat \
# --build-arg NEXT_PUBLIC_CLIENT_ID=SPA \
# --build-arg NEXT_PUBLIC_USER_URL=https://voice-chat.pl \
# --build-arg NEXT_PUBLIC_VOICE_URL=https://voice-chat.pl \
# -t jankotanimesigma/voicechat-spa:latest .
# [+] Building 139.4s (14/14) FINISHED                           docker:default